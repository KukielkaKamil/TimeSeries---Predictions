---
title: "Analiza danych - Projekt v.0.1"
author: "Kamil Kukiełka, Michał Zakielarz, Klaudia Kopeć"
date: "2024-06-20"
output:
  pdf_document: default
  html_document: default
---
```{r}
library(forecast)
library(dplyr)
library(urca)
library(ggplot2)
library(lmtest)
library(skedastic)
```


# Zaczytanie danych i ich przygotowanie
W tym projekcie będziemy korzystać z kilku zestawów danych, tak aby wykazać, że pomimo danych z różnych dziedzin ich predyckja jest w jakimś sposób możliwa
```{r message=TRUE, warning=FALSE, echo=FALSE}
setwd("C:/Users/klaud/Desktop/projekt R/szeregi_czasowe")
options(digits=12)
raw_data1 <- read.csv("dane_firmy.csv",stringsAsFactors=FALSE)
raw_data2 <- read.csv("rainfall.csv",stringsAsFactors = FALSE)
raw_data3 <- read.csv("public_debt.csv",stringsAsFactors = FALSE)
#raw_data4 <- read.csv("dane.csv",stringsAsFactors = FALSE)
```
## Zbiór 1
Nasz pierwszy zestaw dotyczy różnych wskaźników pewnego przedsiębiorstwa, które zmienieniają się w czasie. Dane te były aktualizowane co miesiąc i obejmują zakres od 01.01.2015 do 01.02.2020
Teraz przedstawimy fragment naszych danych aby wiedzieć z czym mamy doczynienia.
## Zestaw 1
Zawiera on przychodów naszego przedsiębiorstwa.
```{r,echo=FALSE}
z1df1 <- data.frame(raw_data1$Period,raw_data1$Revenue)
colnames(z1df1)<-c("Period","Revenue")
head(z1df1, n=12)
```

## Zestaw 2
Zawiera ilość sprzedarzy w naszej firmie.
```{r,echo=FALSE}
z1df2 <- data.frame(raw_data1$Period,raw_data1$Sales_quantity)
colnames(z1df2)<-c("Period","Sales_quantity")
head(z1df2, n=12)
```
## Zestaw 3
Zawiera średni koszt produkcji w naszej firmie.
```{r,echo=FALSE}
z1df3 <- data.frame(raw_data1$Period,raw_data1$Average_cost)
colnames(z1df3)<-c("Period","Average_cost")
head(z1df3, n=12)
```

## Zestaw 4
Zawiera informację o średniej liczbie pracowników w regionie (rocznie).
```{r,echo=FALSE}
z1df4 <- data.frame(raw_data1$Period,raw_data1$The_average_annual_payroll_of_the_region)
colnames(z1df4)<-c("Period","Average_annual_payroll_of_regiion")
head(z1df4, n=12)
```

## Zbiór 2
Obejmuje średnią dzienną temperaturę w Mumbaiu. Nasz zbiór zawiera więcej danych takich jak wilgoć, prędkość czy kierunek wiartu, jednak my skupimy się tylok na temperaturze.
```{r, echo=FALSE}
z2df1 <- data.frame(raw_data2$datetime,raw_data2$temp)
colnames(z2df1) <- c("Data","Temperatura")
head(z2df1, n=12)
```
## Zbiór 3
Zawiera on kwartalne dane o długu publicznym USA (podany w milionach USD).
```{r, echo=FALSE}
z3df1 <- data.frame(raw_data3$date,raw_data3$value)
colnames(z3df1) <- c("Data","Dług")
head(z3df1, n=12)
```
# Zamiana na szereg czasowy
Teraz kiedy mamy już nasze dane musimy je zamienić na szeregi czasowe.
```{r}
z1ts1 <- ts(z1df1$Revenue,start=c(2015,1),frequency = 12)
z1ts2 <- ts(z1df2$Sales_quantity,start=c(2015,1),frequency = 12)
z1ts3 <- ts(z1df3$Average_cost,start=c(2015,1),frequency = 12)
z1ts4 <- ts(z1df4$Average_annual_payroll_of_regiion,start=c(2015,1),frequency = 12)
z2ts1 <- ts(z2df1$Temperatura, start = c(2016,1,1), frequency = 365)
z3ts1 <- ts(z3df1$Dług, start = c(1966,1), frequency = 4)
```


# Przeprowadzenie testów
## Autokorelacja
## Zbiór 1
### Dla zestawu 1
Autokorelacja przychodów przedsiębiorstwa.
```{r}
acf(z1ts1)
```
Autokorelacja cząstkowa przychodów przedsiębiorstwa.
```{r}
pacf(z1ts1)
```
### Dla zestawu 2
Autokorelacja ilości sprzedarzy w firmie.
```{r}
acf(z1ts2)
```

Autokorelacja cząstkowa ilości sprzedarzy w firmie.
```{r}
pacf(z1ts2)
```
### Dla zestawu 3
Autokorelacja średniego kosztu produkcji w firmie.
```{r}
acf(z1ts3)
```

Autokorelacja średniego kosztu produkcji w firmie.
```{r}
pacf(z1ts3)
```

### Dla zestawu 4
Autokorelacja informacji o średniej liczbie pracowników w regionie.
```{r}
acf(z1ts4)
```

Autokorelacja informacji o średniej liczbie pracowników w regionie.
```{r}
pacf(z1ts4)
```

## Dla zbioru 2
Autokorelacja średniej dziennej temperatury w Mumbaiu.
```{r}
acf(z2ts1)
```

Autokorelacja średniej dziennej temperatury w Mumbaiu.
```{r}
pacf(z2ts1)
```

## Dla zbioru 3
Autokorelacja kwartalnych danych o długu publicznym USA.
```{r}
acf(z3ts1)
```

Autokorelacja kwartalnych danych o długu publicznym USA.
```{r}
pacf(z3ts1)
```

# Test na heteroskedastyczność
Aby określić heteroskedastyczność szeregu, należy najpierw stworzyć model liniowy z naszych szeregów czasowych, a następnie przeprowadzić test Breuscha-Pagana.

### Zbiór 1
## Dla zestawu 1
Heteroskedastyczność przychodów przedsiębiorstwa.
```{r}
df=data.frame(time=1:length(z1ts1),z1ts1)
z1lm1<-lm(z1ts1~time,data = df)
plot(z1lm1$residuals)
 bptest(z1lm1)
```
Z powyższych testów wynika, że wartość p jest mniejsza niż 0,05, co prowadzi do nieodrzucenia hipotezy zerowej. W konsekwencji, nie posiadamy wystarczających dowodów na występowanie heteroskedastyczności.

## Dla zestawu 2
Heteroskedastyczność ilości sprzedarzy w firmie.
```{r}
df=data.frame(time=1:length(z1ts2),z1ts2)
z1lm2<-lm(z1ts2~time,data = df)
plot(z1lm2$residuals)
 bptest(z1lm2)
```
## Dla zestawu 3
Heteroskedastyczność średniego kosztu produkcji w firmie.
```{r}
df=data.frame(time=1:length(z1ts3),z1ts3)
z1lm3<-lm(z1ts3~time,data = df)
plot(z1lm3$residuals)
 bptest(z1lm3)
```

Miejsce na wnioski....

## Dla zestawu 4
Heteroskedastyczność informacji o średniej liczbie pracowników w regionie.
```{r}
df=data.frame(time=1:length(z1ts4),z1ts4)
z1lm4<-lm(z1ts4~time,data = df)
plot(z1lm4$residuals)
 bptest(z1lm4)
```

Miejsce na wnioski....

### Zbioru 2
Heteroskedastyczność średniej dziennej temperatury w Mumbaiu.
```{r}
df=data.frame(time=1:length(z2ts1),z2ts1)
z2lm1<-lm(z2ts1~time,data = df)
plot(z2lm1$residuals)
 bptest(z2lm1)
```

Miejsce na wnioski....

### Zbioru 3
Heteroskedastyczność kwartalnych danych o długu publicznym USA.
```{r}
df=data.frame(time=1:length(z3ts1),z3ts1)
z3lm1<-lm(z3ts1~time,data = df)
plot(z3lm1$residuals)
 bptest(z3lm1)
```

Miejsce na wnioski....


# Test na stacjonarność szergu

## Dla zbioru 1
```{r}
urca::ur.kpss(z1ts1) %>% summary() #niestacjonarny
diff(z1ts1) %>% urca::ur.kpss() %>% summary() # stacjonarny
```
# Tworzenie modelu
Bazując na naszych wcześniejszych danych musimy teraz dobrać odpowiednie parametry naszego modelu. Jako iż będziemy korzystać z modelu Arima potrzebujemy wartośći parametrów p,d,q.
```{r}
plot(z1ts1) #roboczo
```
Aby wyznaczyć parametr p patrzymy na nasze korelogramy.
```{r}
acf(z1ts1)
pacf(z1ts1)
```
Możemy na nich zauważyć, że nie występuje jednoznaczna autokorelacja. W takim wypadku możemy nasze dane zróżnicować
```{r}
acf(diff(z1ts1,lag = 1))
pacf(diff(z1ts1,lag = 12))
```
Na podstawie powyższych wykresów mając orientację jakie wartości możemy wrzucić do modelu testujemy kilka opcji

```{r}
print("Wersja 1")
Arima(y=z1ts1, order = c(3,1,3),lambda = NULL)
print("Wersja 2")
Arima(y=z1ts1,lambda = NULL,seasonal = c(3,1,3))
print("Wersja 3")
Arima(y=z1ts1, order = c(0,1,0),lambda = NULL)
print("Wersja 4")
test <- Arima(y=z1ts1,lambda = NULL,seasonal = c(1,1,1))
print("Wersja 5")
Arima(y=z1ts1, order = c(0,1,0),lambda = "auto")
print("Wersja 6")
z1tst1_best_model <- Arima(y=z1ts1,lambda = "auto",seasonal = c(0,1,0))
z1tst1_best_model
```
Z pośród stoworznych modeli wybraliśmy najlepszy, teraz spróbujemy stowrzyć model AutoArima i spróbujemy go porównać z obecnie najlepszym
```{r}
auto.arima(z1ts1,d=1,max.p = 5,max.q =5,max.d = 5,seasonal = TRUE)
```
Podsumowując nasz wcześniejszy model jest lepszy :)
# Predykcja danych
Teraz mając nasze modele możemy dokonać predykcji
## Zbiór 1
Dla naszego zbioru spróbujemy dokonać predykcji na następny rok
### Predykcja przychodów przedsiębiorstwa
```{r}
forecast_valuesz11 <-forecast(z1tst1_best_model,h=24)
autoplot(z1ts1, series="Original Data") +
  autolayer(forecast_valuesz11, series="Forecast", PI=FALSE) +
  ggtitle("Time Series and ARIMA Forecast") +
  xlab("Time") +
  ylab("Value") +
  theme_minimal() +
  scale_colour_manual(values=c("Original Data"="blue", "Forecast"="red"))
```
# Dekomozycja szeregu
```{r}
decomposedz11 <- decompose(z1ts1)
plot(decomposedz11)
```
Na podstawie powyższych obserwacji możemy stwierdzić, że szereg ma widoczny trend, jest sezonowy oraz występują odchylenia losowe.
